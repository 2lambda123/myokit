#!/usr/bin/env python
import myokit
import myokit.lib.hh as hh

import os
import matplotlib.pyplot as plt

fname = os.path.join('tests', 'data', 'lr-1991-fitting.mmt')
model = myokit.load_model(fname)
#model.get('membrane.V').set_rhs(-120)
m = hh.HHModel.from_component(model.get('ina'))

b = myokit.Benchmarker()

vs = [-30, -20, -10]
p = myokit.pacing.steptrain(
    vsteps=vs,
    vhold=-120,
    tpre=8,
    tstep=2,
    tpost=0)
t = p.characteristic_time()

s1 = hh.AnalyticalSimulation(m, p)
b.reset()
d1 = s1.run(t, log_interval=0.1).npview()
print(b.time())

model.get('membrane.V').set_binding('pace')
s2 = myokit.Simulation(model, p)
s2.set_tolerance(1e-8, 1e-8)
b.reset()
d2 = s2.run(t, log_interval=0.1).npview()
print(b.time())

if True:
    plt.figure()
    plt.subplot(3, 1, 1)
    plt.plot(d1.time(), d1['ina.m'] - d2['ina.m'])
    #plt.plot(d2.time(), d2['ina.m'])
    plt.subplot(3, 1, 2)
    plt.plot(d1.time(), d1['ina.h'] - d2['ina.h'])
    #plt.plot(d2.time(), d2['ina.h'])
    plt.subplot(3, 1, 3)
    plt.plot(d1.time(), d1['ina.j'] - d2['ina.j'])
    #plt.plot(d2.time(), d2['ina.j'])

    plt.figure()
    n = 20
    plt.subplot(4, 1, 1)
    plt.plot(d1.time()[:n], d1['ina.m'][:n], label='Analytical')
    plt.plot(d2.time()[:n], d2['ina.m'][:n], label='CVODE')
    plt.legend()
    plt.subplot(4, 1, 2)
    plt.plot(d1.time()[:n], d1['ina.h'][:n])
    plt.plot(d2.time()[:n], d2['ina.h'][:n])
    plt.subplot(4, 1, 3)
    plt.plot(d1.time()[:n], d1['ina.j'][:n])
    plt.plot(d2.time()[:n], d2['ina.j'][:n])
    plt.subplot(4, 1, 4)
    plt.plot(d1.time()[:n], d1['membrane.V'][:n])
    plt.plot(d2.time()[:n], d2['membrane.V'][:n])

    d1 = d1.fold(10).trim_left(8, adjust=True)
    d2 = d2.fold(10).trim_left(8, adjust=True)

    plt.figure()
    plt.title('LR 91 HH INa model')
    plt.plot(d1.time(), d1['ina.INa', 0], 'x-', color='tab:blue', label='analytical')
    plt.plot(d1.time(), d1['ina.INa', 1], 'x-', color='tab:orange')
    plt.plot(d1.time(), d1['ina.INa', 2], 'x-', color='tab:green')
    plt.plot(d2.time(), d2['ina.INa', 0], '+--', color='tab:blue', label='cvode')
    plt.plot(d2.time(), d2['ina.INa', 1], '+--', color='tab:orange')
    plt.plot(d2.time(), d2['ina.INa', 2], '+--', color='tab:green')
    plt.legend()
    plt.show()

